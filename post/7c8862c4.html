<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>MQTT学习笔记 | Luckys-Yangの小栈</title><meta name="author" content="Luckys-Yang"><meta name="copyright" content="Luckys-Yang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="介绍 MQTT的全称为Message Queue Telemetry Transport（消息队列遥测传输协议），由IBM公司制定。是一种轻量级的、基于“发布&#x2F;订阅”模式的消息传输协议。 MQTT协议是基于 TCP 的一个 应用层 协议 MQTT协议具有以下特性：  基于 TCP 协议的应用层协议； 采用 C&#x2F;S 架构； 使用订阅&#x2F;发布模式，将消息的发送方和接受方解耦； 提供 3 种消息的 QoS">
<meta property="og:type" content="article">
<meta property="og:title" content="MQTT学习笔记">
<meta property="og:url" content="https://mdcm.yang5201314.cn/post/7c8862c4.html">
<meta property="og:site_name" content="Luckys-Yangの小栈">
<meta property="og:description" content="介绍 MQTT的全称为Message Queue Telemetry Transport（消息队列遥测传输协议），由IBM公司制定。是一种轻量级的、基于“发布&#x2F;订阅”模式的消息传输协议。 MQTT协议是基于 TCP 的一个 应用层 协议 MQTT协议具有以下特性：  基于 TCP 协议的应用层协议； 采用 C&#x2F;S 架构； 使用订阅&#x2F;发布模式，将消息的发送方和接受方解耦； 提供 3 种消息的 QoS">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mdcm.yang5201314.cn/img/num87.webp">
<meta property="article:published_time" content="2022-09-22T05:15:00.000Z">
<meta property="article:modified_time" content="2022-09-22T09:57:31.000Z">
<meta property="article:author" content="Luckys-Yang">
<meta property="article:tag" content="MQTT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mdcm.yang5201314.cn/img/num87.webp"><link rel="shortcut icon" href="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/blog_other/93801118587.webp"><link rel="canonical" href="https://mdcm.yang5201314.cn/post/7c8862c4.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"MSZRRKNRKT","apiKey":"71e2a5ac35435ee76602cd55d727e5ff","indexName":"aaa","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.staticfile.org/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdn.staticfile.org/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MQTT学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-22 17:57:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/rightmenu.css" media="all" onload="this.media='all'"><link rel="preconnect" href="https://s1.hdslb.com/" /><link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" media="all" onload="this.media='all'" /><link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/medium.css" media="all" onload="this.media='all'" /><link rel="shortcut icon" href="#"><link href="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/css/all.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/my.css" media="all" onload="this.media='all'"><link rel="stylesheet" href="/css/universe.css" ><link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/izitoast@1.4.0/dist/css/iziToast.min.css" media="all" onload="this.media='all'"><link rel="stylesheet" href="/css/aplayer.css" media="all" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://jsd.onmicrosoft.cn/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><style>css-doodle {--color: @p(#51eaea, #fffde1, #ff9d76, #FB3569);--rule: (:doodle {@grid: 30x1 / 18vmin;--deg: @p(-180deg, 180deg);}:container {perspective: 30vmin;}:after, :before {content: '';background: var(--color); @place-cell: @r(100%) @r(100%); @size: @r(6px); @shape: heart;} @place-cell: center; @size: 100%;box-shadow: @m2(0 0 50px var(--color));background: @m100(radial-gradient(var(--color) 50%, transparent 0)@r(-20%, 120%) @r(-20%, 100%) / 1px 1px no-repeat); will-change: transform, opacity; animation: scale-up 12s linear infinite; animation-delay: calc(-12s / @I * @i); @keyframes scale-up { 0%, 95.01%, 100% {transform: translateZ(0) rotate(0);opacity: 0;}10% {opacity: 1;}95% {transform: translateZ(35vmin) rotateZ(@var(--deg));}})}</style><css-doodle use="var(--rule)"></css-doodle><script async="async" src="https://cdn.bootcdn.net/ajax/libs/css-doodle/0.32.2/css-doodle.min.js"></script></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/blog_other/93801118587.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">136</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-list-alt"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/bookmarking/"><i class="fa-fw fas fa-star"></i><span> 收藏</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo/"><i class="fa-fw fas fa-pen"></i><span> 说说</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-info-circle"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav class="fixed" id="nav"><span id="blog-info"><a href="/" title="Luckys-Yangの小栈"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/light.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-list-alt"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/bookmarking/"><i class="fa-fw fas fa-star"></i><span> 收藏</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comment"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page" href="/shuoshuo/"><i class="fa-fw fas fa-pen"></i><span> 说说</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-info-circle"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">MQTT学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-22T05:15:00.000Z" title="发表于 2022-09-22 13:15:00">2022-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-22T09:57:31.000Z" title="更新于 2022-09-22 17:57:31">2022-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/32%E7%B3%BB%E5%88%97/">32系列</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span></div></div></div><article class="post-content" id="article-container"><h2 id="介绍">介绍</h2>
<p>MQTT的全称为Message Queue Telemetry Transport（<a href="https://so.csdn.net/so/search?q=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97&amp;spm=1001.2101.3001.7020">消息队列</a>遥测传输协议），由IBM公司制定。是一种轻量级的、基于“发布/订阅”模式的消息传输协议。</p>
<p>MQTT协议是基于 TCP 的一个 <code>应用层</code> 协议</p>
<p>MQTT协议具有以下特性：</p>
<ul>
<li>基于 TCP 协议的应用层协议；</li>
<li>采用 C/S 架构；</li>
<li>使用订阅/发布模式，将消息的发送方和接受方解耦；</li>
<li>提供 3 种消息的 <code>QoS</code>（Quality of Service）: 至多一次(可能会丢包)，最少一次(保证包到达，可能会出现重包)，只有一次(保证包会到达目的地，且不会出现重包)；</li>
<li>收发消息都是 <code>异步</code> 的，发送方不需要等待接收方应答。</li>
</ul>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>MQTT协议的通信模型</p>
</div>
<p>MQTT的通信时通过 <code>发布/订阅</code> 的方式来实现，订阅和发布又是基于 <code>主题</code> (Topic)的。发布方和订阅方通过这种方式来进行解耦，没有直接地连接，需要一个中间方。在MQTT里，中间方称之为 <code>Broker</code>，用来进行 <code>消息的存储与转发</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/d1e53151a712484f89da7f277f4612c7.jpg" alt=""></p>
<ol>
<li>
<p><code>发布方(Publisher)连接到Broker</code></p>
</li>
<li>
<p><code>订阅方(Subscriber)连接到Broker，并订阅主题Topic1</code></p>
</li>
<li>
<p><code>发布方(Publisher)发送给Broker一条消息，主题为Topic1</code></p>
</li>
<li>
<p><code>Broker收到了发布方的消息，发现订阅方(Subscriber)订阅了Topic1,然后将消息转发给订阅方(Subscriber)</code></p>
</li>
<li>
<p><code>订阅方(Subscriber)从Broker接受该数据。</code></p>
</li>
</ol>
<p>MQTT通过订阅与发布模型对消息的发布方和订阅方进行解耦后，发布方在发布消息时 <code>并不需要订阅方也连接到Broker</code>，只要订阅方之前订阅过相应主题，那么 <code>它在连接到Broker之后就可以收到发布方在它离线期间发布的消息</code>。我们可以称这种消息为 <code>离线消息</code>。</p>
<p>​      根据上述描述，这里可以做个简单的总结。比如现在有两个具有联网功能的MCU，这俩就是 <code>客户端</code>。然后在远程服务器上搭建一个MQTT服务器，那这个MQTT服务器就是 <code>Broker</code>。现在 <code>MCU_A对Broker进行订阅Topic</code>，化身为 <code>Subscriber</code>。 <code>MCU_B连接MQTT服务器后，向Topic进行发布消息</code>，化身为 <code>Publisher</code>。这样MCU_A就会收到MCU_B发布过来的消息。这时候MCU_A关机了，MCU_B又发布了消息，此时MCU_A肯定是接收不到消息的，因为关机了。此时MCU_B赌气，也关机了。那整个网络中就只剩下Broker了。此时，MCU_A开机，因为之前订阅过了Topic，那Broker检测到MCU_A上线后，就会推送消息给A。这样 <code>即使MCU_B不在线，MCU_A也能收到B的离线消息</code> 。这个消息是缓存在Broker中。以上过程中，A是订阅者，B是发布者。那这时候如果B也订阅Topic呢？那B即是发布者，也是订阅者。</p>
<h2 id="名词解释">名词解释</h2>
<p><code>Publisher和Subscriber</code>：Publisher和Subscriber是相对于Topic来说的。如果一个Client向某个Topic发布消息，那么这个Client就是Publisher。如果一个Client订阅了某个Topic，那么它就是Subscriber。换句话来说的话，<span style="color:# e80daf">一个Client即可以是发布者，也可以是订阅者</span></p>
<p><code>Broker</code>：MQTT的Broker负责接受发布者的消息，并发送给相应的订阅者，是整个MQTT订阅发布的核心。一般情况下，<span style="color:# e80daf">Broker都是服务器</span></p>
<p><code>Client和Server</code>：客户端可以是任何终端设备，而服务端大部分情况下都是Broker。</p>
<p><code>Topic</code>：Topic是UTF-8字符串，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容</p>
<p><code>Topic类</code>：同一产品下不同设备的Topic集合，用 <code>$&#123;productkey&#125;和$&#123;deviceName&#125;</code>通配一个唯一的设备，一个Topic类对一个ProductKey下所有设备通用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922142009.jpg" alt=""></p>
<ol>
<li>产品的Topic类不用于通信，只用来定义Topic,真正用来消息通信的是Topic，Topic和Topic类的格式一致，区别在于，Topic类中的变量<span style="color:# e80daf">${deviceName}</span>，</li>
<li>在Topic中是具体的设备名称，设备对应的Topic是从产品对应的Topic类中映射出来，根据设备名称而动态创建的。设备的Topic中带有设备名称即DeviceName，只能被该设备用来Pub和Sub通信</li>
<li>在配置规则引擎时，配置的Topic中可使用<span style="color:# e80daf">通配符</span>，且同一个类中只能出现一个通配符</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/20180804170202185.jpg" alt=""></p>
<p>还有一些使用限制详见[文档](<a href="https://help.aliyun.com/document_detail/30527.htm?spm=a2c4g.11186623.0.0.12df6401VcVSvX#">https://help.aliyun.com/document_detail/30527.htm?spm=a2c4g.11186623.0.0.12df6401VcVSvX#</a> section-mmp-bdv-4fb)</p>
<p><code>payload</code>：可以理解为消息的内容，是指订阅者具体要使用的内容</p>
<p><code>网关</code>：能够直接连接物联网平台的设备，且具有子设备管理功能，能够代理子设备连接云端</p>
<p><code>子设备</code>：子设备不能直接连接物联网平台，只能通过网关连接</p>
<p><code>三元组</code>：</p>
<ul>
<li>
<p><span style="color:# e80daf">PublicKey</span>：物联网平台为产品颁发的唯一标识，在设备通信及认证中都要用到，需妥善保管。</p>
</li>
<li>
<p><span style="color:# e80daf">DeviceName</span>：在注册设备时，自定义的或者自动生成的设备名称，在通信及认证中都要用到，需妥善保管。</p>
</li>
<li>
<p><span style="color:# e80daf">DeviceSecret</span>：物联网平台为设备颁发的设备秘钥，和DeviceName成对出现，在设备认证时会用，需妥善保管</p>
</li>
</ul>
<p><code>属性</code>：设备的功能模型之一，一般用于描述设备运行时的状态，如环境监测设备所读取的环境温度等，属性支持<span style="color:# e80daf">GET和SET</span>两种请求方式，应用系统可发起对属性的读取或设置请求</p>
<p><code>服务</code>：设备的功能模型之一，设备可被外部调用的能力或者方法，可设置输入参数或输出参数。相比属性，服务可用一条指令实现更复杂的业务逻辑，如执行某项特定的任务</p>
<p><code>事件</code>：设备的功能模型之一，设备运行时的事件，事件一般包含需要被外部感知和处理的通知消息，可包含多个输出参数。如。某项任务完成的信息，设备发生故障报警时的问题等，事件可以被订阅和推送</p>
<p><code>设备影子</code>：是一个JSON文档，用于存储设备或者应用的当前状态信息。每个设备都会在云端有唯一的设备影子对应，无论设备有没有连接到Internet，都可以使用设备影子通过MQTT或者HTTP获取或者设置设备的状态</p>
<p><code>QoS</code>：可靠传输保证；有三种消息发布服务质量</p>
<ol>
<li><span style="color:# e80daf">QoS0</span>：“至多一次”，消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复</li>
<li><span style="color:# e80daf">QoS1</span>：“至少一次”，确保消息到达，但消息重复可能会发生</li>
<li><span style="color:# e80daf">QoS2</span>：“只有一次”，确保消息到达一次，为此，带有唯一消息 ID 的消息会存储两次，首先来自发送者，然后是接收者。QoS 级别 2 在网络中具有最高的开销，因为在发送方和接收方之间需要两个流</li>
</ol>
<h2 id="连接与断开">连接与断开</h2>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>MQTT连接过程</p>
</div>
<ul>
<li>Client(客户端)建立到Broker的连接过程如下：</li>
</ul>
<ol>
<li>Client发送connect数据包给Broker</li>
<li>Broker在收到connect数据包后，给Client返回一个connACK数据包</li>
</ol>
<p><code>connect数据包</code>：客户端标识符(Client identifier 唯一的)、用户名(Username)、密码(Password)、遗愿主题(will topic)，当client非正常地中断连接时，Broker将会向制定的遗愿主题中发布遗愿消息、遗愿消息(will message)</p>
<p><code> connACK数据包</code>：连接返回码(Connect Return code)用于标识连接是否建立成功。 <code>0标识成功</code></p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>MQTT断开过程</p>
</div>
<ul>
<li>Client 主动关闭连接</li>
</ul>
<p>client主动关闭连接只需要向Broker发送一个 <code>Disconnect</code> 数据包就可以了。<span style="color:# e80daf">发送完后，就可以关闭底层的TCP连接了，不需要等待Broker的回复</span>(Broker也不会对Disconnect数据包进行回复)。</p>
<p><span style="color:green">问</span>： 为什么Client关闭TCP连接之前，要发送一个和Broker没有交互的数据包，而不是关闭底层的TCP连接？<span style="color:red">答</span>：因为涉及到MQTT协议的一个特性。在MQTT协议中，Broker需要判断Client是否是正常的断开连接。当Broker收到Client的Disconnect数据包的时候，Broker则认为Client是 <code>正常断开</code>，那么会丢弃当前连接指定的遗愿消息。如果Broker检测到Client连接丢失，但是又没有收到Disconnect数据包，则认为Client是 <code>非正常断开</code>的，就会向在连接的时候指定的遗愿主题发布遗愿消息。</p>
<ul>
<li>Broker主动关闭连接</li>
</ul>
<p>MQTT协议规定Broker在没有收到Client的DISCONNECT数据包之前都应该和Client保持连接。只有当Broker 在连接保活(Keep Alive)的时间间隔内，没有收到Client的任何MQTT数据包的时候会主动关闭连接。一些Broker的实现在MQTT协议上做了一些拓展，支持Client的连接管理，可以主动和某个Client断开连接。</p>
<p><span style="color:red">注意</span>： Broker主动关闭连接之前不会向Client发送任何MQTT数据包，而是直接关闭底层的TCP连接</p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>连接保活(Keep alive)</p>
</div>
<p>Broker需要知道Client是否正常地断开了和它的连接，以发出遗愿消息。实际上Client也需要能够很快的检测它失去了和Broker的连接，以便重新连接。虽然TCP协议在丢失连接时会通知上层应用，但是TCP有一个半打开连接的问题(half-open connection)，在这种状态下，一端的TCP连接已经失效，但是另外一端并不知情，它认为连接依然是打开的，它需要很长时间才能感知到对端已经连接断开了，这种情况在使用移动或卫星网络的时候尤为常见。所以仅仅依赖TCP的连接状态是不够的，于是MQTT协议设计了一套Keep alive机制。</p>
<p>在建立连接的时候，我们可以传递一个 <code>Keep alive参数，它的单位是秒</code>。MQTT协议中规定： <code>在1.5倍的Keep alive的时间间隔内，如果Broker没有收到来自Client的任何数据包，那么Broker认为它和Client之间的连接已经断开；同样如果Client没有收到来自Broker的任何数据包，那么Client认为它和Broker之间的连接已经断开。</code>在Broker和Client之间没有任何数据包传输的时候，MQTT中通过 <code>PINGREQ/PINGRESP</code> 来满足Keep alive的约定和侦测连接状态。</p>
<p><code> PINGREQ数据包</code>：当Client在一个Keep alive时间间隔内没有向Broker发送任何数据包，比如Publish和Subscribe的时候，它应该向Broker发送PINGREQ数据包。</p>
<p><code>PINGRESP数据包</code>：收到PINGREQ数据包后，会回复一个PINGRESP数据包</p>
<div class="note red icon-padding flat"><i class="note-icon fas fa-fan"></i><p>对于Keep alive机制，还需要注意以下几点</p>
</div>
<ul>
<li><code>如果在一个Keep Alive时间间隔内，Client和Broker有过数据包传输，比如PUBLISH数据包，Client就没有必要再使用PINGREQ了；</code></li>
<li><code>Keep Alive值是由Client指定，不同的Client可以指定不同的值；</code></li>
<li><code>Keep Alive的最大值为18小时12分15秒即65535秒；</code></li>
<li><code>Keep Alive的值设为0的话，代表不使用Keep Alive机制</code></li>
</ul>
<h2 id="订阅和发布">订阅和发布</h2>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>订阅</p>
</div>
<ol>
<li>
<p>Client向Broker发送一个Subscriber数据包，该数据包中含有Client想要订阅的主题和其他一些参数。</p>
</li>
<li>
<p>Broker收到Subscribe数据包后，向Client发送一个SubACK数据包作为应答。</p>
</li>
</ol>
<p><code>Subscribe数据包</code>：数据包标识(Packet identifier)两个字节(唯一)、订阅列表(List of Subscriptions)包含Client想要订阅的主题列表，列表中的每项由订阅主题名和对应的QoS组成。</p>
<p><code>SubACK数据包</code>：数据包标识(Packet identifier)两个字节(唯一)、返回码(return codes)包含一组返回码，返回码的数量和顺序和Subscribe数据包的订阅列表对应，用于标识订阅类别中的每一个订阅项的订阅结果。</p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>取消订阅</p>
</div>
<ol>
<li>
<p>Subscriber向Broker发送一个Unsubscribe数据包，该数据包包含想要取消订阅的主题。</p>
</li>
<li>
<p>Broker收到Unsubscribe数据包之后，向Subscirber发送一个UnsubACK数据包作为应答。</p>
</li>
</ol>
<p><code>Unsubscribe数据包</code>：数据包标识(Packet identifier)两个字节(唯一)、主题列表(List of Topics)包含Client想要取消订阅的主题过滤器列表。</p>
<p><code>UnsubACK数据包</code>：数据包标识(Packet identifier)两个字节(唯一)</p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>发布</p>
</div>
<p>MQTT发布中最重要的是 <code>Publish数据包</code>，Publish数据包是用于发送方和接收方之间传输消息的。当Publisher要向某个Topic发布一条消息时，Publisher会向Broker发送一个Publish数据包。当Broker要将一条消息转发给订阅了某条主题的Subscriber时，Broker也会向该Subscriber发送一个Publish数据包。接收方会根据数据包中的QoS决定应答，当QoS（Quality of Service）为0时，接收方不做任何应答。</p>
<p><code>Publish数据包</code>：<span style="color:# e80daf">消息重复标识(DUP flag)</span>：当DUP flag=1时，代表该消息是一条重发消息，因接收方没有确认收到之前的消息而重发的(只有在QoS大于0的消息中使用)、<span style="color:# e80daf">QoS、Retain标识</span>：当被设置为1时，Broker应该保存该条消息，当之后有任何新的Subscriber订阅Publish消息中指定的主题时，都会先收到该条消息，这种消息也叫Retained消息、<span style="color:# e80daf">数据包标识(Packet identifier)两个字节(唯一)</span>、<span style="color:# e80daf">主题名称(Topic Name)</span>：该消息发布到哪个主题。</p>
<h2 id="MQTT协议数据包结构">MQTT协议数据包结构</h2>
<p>在MQTT协议中，一个MQTT数据包由三部分组成：</p>
<ul>
<li><code>固定头（Fixed header）</code>：存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识</li>
<li><code>可变头（Variable header）</code>：存在于部分<code>MQTT</code>数据包中，数据包类型决定了可变头是否存在及其具体内容</li>
<li><code>消息体（payload）</code>：存在于部分<code>MQTT</code>数据包中，表示客户端收到的具体内容</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922154812.jpg" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/bead03d52096eca7366e94c5dc43ca29.jpg" alt=""></p>
<p><code>CONNECT报文</code> 有且只有一个，并且是客户端到服务端 建立连接 后的第一个报文， <code>服务端必须将客户端发送的第二个CONNECT报文当作协议违规处理并断开客户端的连接</code></p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>MQTT固定头 分析</p>
</div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/1aee540639d1b9348ec28952fa4416b3.jpg" alt=""></p>
<p><code>Byte1,bits7~4</code>：4位无符号值，类型如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/139bda1041be4c05b97bc25ea7a919a8.jpg" alt=""></p>
<p><code>Byte1,bits3~0</code>：首字节的低4位(bit3~bit0)用来表示某些报文类型的控制字段，实际上只有少数报文类型有控制位</p>
<p><code>bits[3]</code>为DUP字段，如果值为1，表明这个数据包是一条重复的消息；否则该数据包就是第一次发布的消息</p>
<p><code>bit[2],bit[1]</code>为QoS字段，如果<span style="color:# e80daf">bits[1]和bits[2]都为0，表示Qos 0(至多一次)</span>；如果<span style="color:# e80daf">bit[1]为1，表示Qos 1(至少一次)</span>；如果<span style="color:# e80daf">bits[2]为1，表示Qos 2(只有一次)</span>；如果<span style="color:# e80daf">同时将bits[1] 和 bits[2] 设置为1，那么客户端或服务器认为这是一条非法的消息，会关闭当前连接</span></p>
<p><span style="color:red">注</span>：目前bits[3~0]只在PUBLISH协议中使用有效，并且表中指明了是 <code>MQTT 3.1.1版本</code>。对于其它MQTT协议版本，内容可能不同。所有固定头标记为&quot;保留&quot;的协议类型，bits[3~0]必须保持与表中保持一致，如SUBSCRIBE协议，其bits[1]必须为 1 。如果接收方接收到非法的消息，会强行关闭当前连接。</p>
<p><code>bits[0]</code>为RETAIN字段，发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/08d3eb37300d4b57b5700988ec1bd58e.jpg" alt=""></p>
<p><code>剩余长度（Remaining Length）</code>：固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。这一字节是可以扩展，其保存机制，前7位用于保存长度，后一部用做标识。当最后一位为 1时，表示长度不足，需要使用二个字节继续保存</p>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>MQTT可变头 分析</p>
</div>
<p>按顺序包含四个字段：</p>
<ul>
<li>协议名（Protocol Name）</li>
<li>协议级别（Protocol Level）</li>
<li>连接标志（Connect Flags）</li>
<li>连接保活（Keep Alive）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/4bd8f68090344369ba8889b09be8a530.jpg" alt=""></p>
<p><code>协议名</code>：表示协议名 “MQTT” 的UTF-8编码的字符串。MQTT规范的后续版本不会改变这个字符串的偏移和长度</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922163723.jpg" alt=""></p>
<p><code>协议级别</code>：为无符号值表示客户端的版本等级。<span style="color:# e80daf">3.1.1版本的协议等级是 4 ，MQTT v5.0的协议版本字段为 5 （0x05）</span></p>
<p><code>连接标志</code>：包含一些用于指定MQTT连接行为的参数。它还指出playload字段是否存在</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922165455.jpg" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922165823.jpg" alt=""></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 字段详解

# MQTT会话(Clean Session)：
MQTT客户端向服务器发起CONNECT请求时，可以通过’Clean Session’标志设置会话。
‘Clean Session’设置为 0 ，表示创建一个持久会话，在客户端断开连接时，会话仍然保持并保存离线消
息，直到会话超时注销。
‘Clean Session’设置为 1 ，表示创建一个新的临时会话，在客户端断开时，会话自动销毁。
# Will Flag&#x2F;Will Qos&#x2F;Will Retain ：
Will Flag设置为 1表示如果连接请求被接受，服务端必须存储一个Will Message，并和网络连接关联起来。之后在网络连接断开的时候必须发布Will Message，除非服务端收到DISCONNECT包删掉了Will Message

Will Message会在某些情况下发布，包括但不限于：
1.服务端发现I&#x2F;O错误或网络失败。
2.客户端在Keep Alive时间内通信失败。
3.客户端没有发送DISCONNECT包就关闭了网络连接。
4.服务端因协议错误关闭了网络连接。

如果Will Flag被设置为 1 ，连接标识中的Will QoS和Will Retain字段将会被服务端用到
Will QoS这两个bits表示发布Will Message时使用QoS的等级
Will Retain这个bit表示Will Message在发布之后是否需要保留

如果Will Flag设置为 0 ，那么Will Retain必须是 0
如果Will Flag设置为 1 ：
如果Will Retain设置为 0 ，那么服务端必须发布Will Message，不必保存
如果Will Retain设置为 1 ，那么服务端必须发布Will Message，并保存

# User Name Flag：
User Name Flag设置为 0 则用户名不必出现在载荷中；设置为 1 则必须出现在载荷中

# Password Flag
Password Flag设置为 0 则密码不必出现在载荷中；设置为 1 则必须出现在载荷中；如果 User Name Flag设置为 0 ，那么Password Flag必须设置为 0 </code></pre>
<p><code>连接保活</code>：</p>
<ol>
<li>Keep Alive是以 <code>秒</code> 为单位的时间间隔。用 <code>2</code> 字节表示，它指的是 <code>客户端从发送完成一个控制包到开始发送下一个的最大时间间隔</code></li>
<li>客户端有责任 <code>确保两个控制包发送的间隔不能超过Keep Alive的值。如果没有其他控制包可发，客户端必须发送PINGREQ包</code></li>
<li>客户端可以在任何时间发送PINGREQ包，不用关心Keep Alive的值， <code>用PINGRESP来判断与服务端的网络连接是否正常。</code></li>
<li>如果Keep Alive的值 <code>非 0 </code>，而且服务端在 <code>一个半Keep Alive的周期 </code>内没有收到客户端的控制包，服务端必须作为网络故障 <code>断开网络连接</code></li>
<li>如果客户端在发送了PINGREQ后，在一个合理的时间都 <code>没有收到PINGRESP包</code>，客户端应该关闭和服务端的网络连接</li>
<li>Keep Alive的值 <code>为 0</code> ，就关闭了维持的机制。这意味着， <code>客户端不断开连接</code></li>
</ol>
<p><span style="color:red">备注</span>：不管保持连接的值是多少，任何时候，只要服务端认为客户端是不活跃或无响应的，可以断开客户端的连接</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 心跳的作用
PINGREQ包从客户端发往服务端，可以用来：
1 ：在没有其他控制包从客户端发送给服务端的时候，告知服务端客户端的存活状态。
2 ：请求服务端响应，来确认服务端是否存活。
3 ：确认网络连接的有效性。
PINGRESP包从服务端发送给客户端来响应PINGREQ包。它代表服务端是存活的。</code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922172007.jpg" alt=""></p>
<p><span style="color:red">备注</span>：</p>
<ol>
<li>有效负载（playload）字段的存在与否并不是 Reserved字段来指定，而是 <code>will flag、user Name</code>等字段。比如：如果will flag为1，则负载中需要包含will tpoic、will message等字段。如果需要用户名密码，则负载中需要包含这些信息。</li>
<li>服务端必须验证CONNECT控制报文的保留标志位（第0位Reserved）是否为0， <code>如果不为0必须断开客户端连接</code></li>
</ol>
<div class="note blue icon-padding flat"><i class="note-icon fas fa-fan"></i><p>MQTT消息体(Payload)分析</p>
</div>
<p>有些报文类型是包含 <code>Payload</code> 的，Payload意思是消息载体的意思，如 PUBLISH 的Payload就是指消息内容（应用程序发布的消息内容）。而CONNECT的Payload则包含 <code>ClientIdentifier，Will Topic，Will Message，Username，Password</code> 等信息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/%E5%85%B6%E4%BB%96/QQ%E6%88%AA%E5%9B%BE20220922174305.jpg" alt=""></p>
<h2 id="遗言机制">遗言机制</h2>
<p>因为MQTT会运行在网络不好的环境中。可以合理的假设，在这些环境中，客户端偶尔会不正常的断开连接。原因包括连接丢失，电量为空等等。了解客户端是正常断连(发送了DISCONNECT消息)还是非正常断连(没有发送DISCONNECT消息)，这对你正确做出响应有帮助。遗言特性为客户端对非正常断连做出响应提供了合适的途径。</p>
<p>在MQTT中，你可以使用遗言去通知其它设备有一个设备异常断连了。每一个客户端在它连接代理的时候都能定义它的遗言。遗言是一个包含主题，保留信息标志，QoS，和负载的普通消息。代理会一直存储该消息，直到该客户端异常断连。面对异常断连，代理会发送遗言给所有订阅了该遗言的主题的客户端。但是如果一个客户端是通过发送DISCONNECT消息正常断连的,代理会丢弃存储的遗言。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 代理什么时候发送遗言?
# 根据MQTT3.1.1的标准，代理在以下情形下必须发送遗言：
1.服务端发现I&#x2F;O错误或网络失败。
2.客户端在Keep Alive时间内通信失败。
3.客户端没有发送DISCONNECT包就关闭了网络连接。
4.服务端因协议错误关闭了网络连接。</code></pre>
<p>MQTT客户端向服务器端CONNECT请求时，可以设置是否发送 <code>遗愿消息(Will Message)标志，和遗愿消 息主题(Topic)与内容(Payload)。</code></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MQTT/">MQTT</a></div><div class="post_share"><div class="social-share" data-image="/img/num87.webp" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">2.</span> <span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%B8%8E%E6%96%AD%E5%BC%80"><span class="toc-number">3.</span> <span class="toc-text">连接与断开</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E5%92%8C%E5%8F%91%E5%B8%83"><span class="toc-number">4.</span> <span class="toc-text">订阅和发布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQTT%E5%8D%8F%E8%AE%AE%E6%95%B0%E6%8D%AE%E5%8C%85%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">MQTT协议数据包结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%97%E8%A8%80%E6%9C%BA%E5%88%B6"><span class="toc-number">6.</span> <span class="toc-text">遗言机制</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Luckys-Yang</div><div class="footer_custom_text"><div class="github-badge"><a href="http://beian.miit.gov.cn/" target="_blank" title="粤ICP备 2022026282号-1" ), pointer;"><span class="badge-subject">粤ICP备</span><span class="badge-value bg-green">2022026282号-1</span></a></div><div class="github-badge"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44070502000559" title="44070502000559号"><span class="badge-subject"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bed.attainment.cn/img/40.png" style="float:left;" />粤公网安备</span><span class="badge-value bg-green">44070502000559号</span></a></div><div><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/blog_other/Frame-Hexo-blue.svg" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/butterfly/blog_other/Theme-Butterfly-6513df.svg" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://vercel.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/Hosted-Vercel-brightgreen.svg" title="本站采用多线部署，次线路托管于Vercel" alt="HEXO"></a></div></div><div id="running-time" style="color: #5c5c5c;"><script>setInterval(()=>{let create_time=Math.round(new Date('3/10/2022 08:00:00').getTime()/1000);let timestamp=Math.round((new Date().getTime()+8*60*60*1000)/1000);let second=timestamp-create_time;let time=new Array(0,0,0,0,0);if(second>=365*24*3600){time[0]=parseInt(second/(365*24*3600));second%=365*24*3600;}if(second>=24*3600){time[1]=parseInt(second/(24*3600));second%=24*3600;}if(second>=3600){time[2]=parseInt(second/3600);second%=3600;}if(second>=60){time[3]=parseInt(second/60);second%=60;}if(second>0){time[4]=second;}currentTimeHtml='本站已苟活了 '+time[0]+' 年 '+time[1]+' 天 '+time[2]+' 时 '+time[3]+' 分 '+time[4]+' 秒';document.getElementById("running-time").innerHTML=currentTimeHtml;},1000);</script></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="简繁转换">繁</button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="nav-music"><div id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()">播放音乐</div><meting-js id="8183137343" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-paw"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="https://yang5201314.cn/"><i class="fa fa-home"></i><span>主页</span></a><a class="rightMenu-item" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a><a class="rightMenu-item" href="/archives/"><i class="fa-solid fa-folder-open"></i><span>文章归档</span></a><a class="rightMenu-item" href="https://www.foreverblog.cn/go.html" target="_blank"><i class="fa fa-certificate"></i><span>虫洞</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script defer src="/js/tw_cn.js"></script><script defer src="https://cdn.staticfile.org/fancyapps-ui/4.0.27/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module" defer></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script defer src="https://jsd.onmicrosoft.cn/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script defer src="https://jsd.onmicrosoft.cn/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia.js"></script><div class="js-pjax"></div><script src="https://jsd.onmicrosoft.cn/npm/prismjs/prism.min.js"></script><script src="https://jsd.onmicrosoft.cn/npm/prismjs/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://jsd.onmicrosoft.cn/npm/prismjs/plugins/line-numbers/prism-line-numbers.min.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script async type="text/javascript" src="https://jsd.onmicrosoft.cn/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script><script>
    document.body.oncopy = function () {
        iziToast.info({
            timeout: 4000, // 关闭弹窗的时间
          // icon: 'Fontawesome', // 图标类别
            closeOnEscape: 'true', // 允许使用Esc键关闭弹窗
            transitionIn: 'bounceInLeft', // 弹窗打开动画
            transitionOut: 'fadeOutRight', // 弹窗关闭动画
            displayMode: 'replace', // 替换已经打开的弹窗
            layout: '2', // Medium模式
            position: 'topRight', // 弹窗位置
            //icon: 'fad fa-copy', // 图标类名
            iconUrl:'https://image-1309791158.cos.ap-guangzhou.myqcloud.com/其他/1122star.svg',
            backgroundColor: 'rgb(179, 182, 180)', // 弹窗背景色
            title: '复制成功', // 通知标题
            message: '键盘敲烂 月薪过万' // 通知消息内容
        });
    }
</script>
<script defer type="text/javascript" src="/js/rightmenu.js"></script><script  type="text/javascript" src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script defer type="text/javascript" src="/js/IPdw.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer data-pjax src="/js/newYear.js"></script><script defer src="/js/my_aplayer.js"></script><script defer src="/js/meting.js"></script><script id="click-heart" src="https://jsd.onmicrosoft.cn/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://jsd.onmicrosoft.cn/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.staticfile.org/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1s');
    arr[i].setAttribute('data-wow-delay', '250ms');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>